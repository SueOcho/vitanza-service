language: cpp

os: linux
dist: focal

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "awdKDFkD44hbXm5cmt1vGoUSy+dq+6kPy/jI6L0+cLy29wT6fj7/Q4lABSu6TQE9P7b/pSRSFX+/snRejGJ+64CLHIkJLzpnLdBMJ6hM7IdL3fGnT10pb7ugLS0zFR/ysOVLA8HWaC9jGe5L3PwhfLmeGapEmYhYDlCRyPImtX5ncVK+entzp33UXHWXQCJnFMcPdjmnBZRP9zcXwM/Mt3OQppyqhQgR71T3wO2NLub/eA78uCgfiAN+sk8hpoPSwFezyRaPediua8WAAUDtUJT/7QmK+POxM/iQhofGWQwHqor8QDtFwEAqsVorNhmSg1rgphHHJu8OP5iRxj0YmMJL3ondy7ihH1C5as3iZVsOrGyrvRNEpgCOvk5XfXTZSfw+yD7lPUPOHd0Mh+mJPcR1hcDD1RonyKHNbt+6+Jio9z/ILPClLdZ76ThnOUm8pkZBdv03BiNSn8Tf0l4lIlMDXe8mU5iIw0Gx/++GxDjj2R1qEd6MlNrWrP3PYhKGZFNAFU8uGZ+5DuxQW8STzCD1YNLVvd4993uX/fupL7mAohOjUiRQP8nCDaW4sYw9OKHt+29IQDKs2gFVD+m7ClC/frFxpLKhgWJeX4lALX3z0jmg8aG9+Go25nWvde2Kvk6ytTFc0XqGj6r7KXbcv6Nl+EFLCzTWmQEl/1qmm90="


jobs:
   include:
        
      - env: DB=mysql
        arch: amd64
        compiler: gcc
       
      - env: DB=dynamo
        arch: amd64
        compiler: gcc

      - env: DB=dynamo
        arch: arm64-graviton2
        compiler: gcc

branches:
    only:
        - main

cache: apt
addons:
  apt:
    packages:
      - libboost-system-dev
      - libmysqlclient-dev
      - libcurl4-openssl-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
      - libpulse-dev
   
  

before_install: 
    - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
    - git clone https://github.com/aws/aws-sdk-cpp.git
    - mkdir aws-sdk-cpp.build && cd aws-sdk-cpp.build
    - cmake ../aws-sdk-cpp -DBUILD_ONLY="dynamodb" -DENABLE_TESTING=OFF -DCUSTOM_MEMORY_MANAGEMENT=OFF  -DBUILD_SHARED_LIBS=OFF
    - sudo make && sudo make install
    - cd ..
    - git clone https://github.com/Thalhammer/jwt-cpp.git
    - mkdir jwt-cpp.build && cd jwt-cpp.build
    - cmake -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF ../jwt-cpp
    - make && sudo make install    
    - cd ..
    - git clone https://github.com/meltwater/served.git
    - mkdir served.build && cd served.build
    - cmake ../served -DSERVED_BUILD_EXAMPLES=OFF -DSERVED_BUILD_TESTS=OFF -DSERVED_BUILD_SHARED=ON -DSERVED_BUILD_STATIC=ON
    - make && sudo make install
    - sudo ln /usr/local/lib/libserved.so.1.4 /usr/lib64/libserved.so.1.4
    - cd ..
    - git clone https://github.com/dominique120/vitanza-service.git
    - mkdir vts && mkdir vts.build && cd vts.build
    - if [ "$DB" = "dynamo" ]; then cmake -DDB_DYNAMO=ON ../vitanza-service; fi
    - if [ "$DB" = "mysql" ]; then cmake -DDB_MYSQL=ON -DDB_DYNAMO=OFF ../vitanza-service; fi
       
script: make -j2

addons:
  coverity_scan:
    project:
      name: "dominique120/vitanza-service"
      description: "microservice implementation for dynbamodb"
    notification_email: dominique120@live.com
    build_command_prepend: "cmake -DDB_DYNAMO=ON  ../vitanza-service"
    build_command: make -j2
    branch_pattern: main